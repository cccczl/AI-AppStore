name: Release # å·¥ä½œæµç¨‹åç§°ï¼šReleaseï¼ˆå‘å¸ƒï¼‰

permissions: # æƒé™é…ç½®
  contents: write # å…è®¸æ­¤å·¥ä½œæµç¨‹å†™å…¥ä»“åº“å†…å®¹ï¼Œç”¨äºåˆ›å»ºå‘å¸ƒç­‰

on: # è§¦å‘æ¡ä»¶é…ç½®
  push: # å½“æœ‰ä»£ç æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘
    paths: # ç›‘å¬æ–‡ä»¶è·¯å¾„
      - '**.yml' # ç›‘å¬æ‰€æœ‰ymlæ–‡ä»¶
      - '**.json' # ç›‘å¬æ‰€æœ‰jsonæ–‡ä»¶
    # tags: # ç›‘å¬æ ‡ç­¾ï¼ˆå·²æ³¨é‡Šï¼Œå–æ¶ˆæ³¨é‡Šåˆ™å¯ç”¨ï¼‰
    #   - 'v*' # è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶
  pull_request: # å½“æœ‰æ‹‰å–è¯·æ±‚æ—¶è§¦å‘
    types: [closed] # å½“æ‹‰å–è¯·æ±‚å…³é—­æ—¶è§¦å‘
    branches: # ç›‘å¬åˆ†æ”¯
      - main # ç›‘å¬ main åˆ†æ”¯
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµç¨‹
    inputs: # æ‰‹åŠ¨è§¦å‘æ—¶çš„è¾“å…¥å‚æ•°
      tags: # æ ‡ç­¾è¾“å…¥å‚æ•°
        description: 'Test tags' # å‚æ•°æè¿°ï¼šæµ‹è¯•æ ‡ç­¾
        required: true # å‚æ•°æ˜¯å¦å¿…å¡«ï¼šæ˜¯
        type: string # å‚æ•°ç±»å‹ï¼šå­—ç¬¦ä¸²

jobs: # ä½œä¸šé…ç½®
  release: # ä½œä¸šåç§°ï¼šreleaseï¼ˆå‘å¸ƒï¼‰
    runs-on: ubuntu-latest # è¿è¡Œç¯å¢ƒï¼šæœ€æ–°ç‰ˆ Ubuntu

    steps: # æ­¥éª¤é…ç½®
      - name: Checkout code # æ­¥éª¤åç§°ï¼šCheckout codeï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4 # ä½¿ç”¨ actions/checkout@v4 åŠ¨ä½œï¼Œç”¨äºæ£€å‡ºä»£ç 
        with: # åŠ¨ä½œå‚æ•°é…ç½®
            fetch-depth: 0  # è·å–å®Œæ•´çš„æäº¤å†å²ï¼Œç¡®ä¿å¯ä»¥è·å–åˆ°æ‰€æœ‰çš„æ ‡ç­¾


      - name: Get Commit Messages # æ­¥éª¤åç§°ï¼šGet Commit Messagesï¼ˆè·å–æäº¤ä¿¡æ¯ï¼‰
        id: get_commit_messages # æ­¥éª¤IDï¼šget_commit_messagesï¼Œç”¨äºåç»­æ­¥éª¤å¼•ç”¨è¾“å‡º
        run: | # è¿è¡Œçš„ Shell è„šæœ¬
          # Get the latest tag # è·å–æœ€æ–°æ ‡ç­¾
          LATEST_TAG=$(git tag --sort=-creatordate | head -n 1) # ä½¿ç”¨ git å‘½ä»¤è·å–æœ€æ–°æ ‡ç­¾ï¼Œå¹¶èµ‹å€¼ç»™ LATEST_TAG å˜é‡

          # If there is no latest tag, get only the latest commit message # å¦‚æœæ²¡æœ‰æœ€æ–°æ ‡ç­¾ï¼Œåˆ™åªè·å–æœ€æ–°çš„æäº¤ä¿¡æ¯
          if [ -z "$LATEST_TAG" ]; then # åˆ¤æ–­ LATEST_TAG å˜é‡æ˜¯å¦ä¸ºç©º
            COMMITS=$(git log -1 --pretty=format:'- %s (%h)') # å¦‚æœä¸ºç©ºï¼Œåˆ™è·å–æœ€è¿‘ä¸€æ¬¡æäº¤çš„ä¿¡æ¯ï¼Œæ ¼å¼ä¸º '- æäº¤ä¿¡æ¯ (æäº¤å“ˆå¸Œå€¼)'
          else # å¦‚æœ LATEST_TAG å˜é‡ä¸ä¸ºç©º
            COMMITS=$(git log --pretty=format:'- %s (%h)' --no-merges "$LATEST_TAG"..HEAD) # è·å–ä»æœ€æ–°æ ‡ç­¾åˆ° HEAD ä¹‹é—´çš„æ‰€æœ‰æäº¤ä¿¡æ¯ï¼Œæ’é™¤åˆå¹¶æäº¤
          fi # if è¯­å¥ç»“æŸ

          # Output Multi-Line String # è¾“å‡ºå¤šè¡Œå­—ç¬¦ä¸²
          echo "commits<<EOF" >> $GITHUB_OUTPUT # å°†å¤šè¡Œå­—ç¬¦ä¸²è¾“å‡ºåˆ° GITHUB_OUTPUT ç¯å¢ƒå˜é‡ï¼Œå˜é‡åä¸º commitsï¼Œèµ·å§‹æ ‡è®°ä¸º EOF
          echo "$COMMITS" >> $GITHUB_OUTPUT # å°† COMMITS å˜é‡çš„å†…å®¹è¾“å‡ºåˆ° GITHUB_OUTPUT ç¯å¢ƒå˜é‡
          echo "EOF" >> $GITHUB_OUTPUT # ç»“æŸæ ‡è®° EOF

          # Get the release date # è·å–å‘å¸ƒæ—¥æœŸ
          RELEASE_DATE=$(date +'%Y%m%d') # ä½¿ç”¨ date å‘½ä»¤è·å–å½“å‰æ—¥æœŸï¼Œæ ¼å¼ä¸º YYYYMMDDï¼Œå¹¶èµ‹å€¼ç»™ RELEASE_DATE å˜é‡
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT # å°†å‘å¸ƒæ—¥æœŸè¾“å‡ºåˆ° GITHUB_OUTPUT ç¯å¢ƒå˜é‡ï¼Œå˜é‡åä¸º release_date

      - name: Delete tag and release # æ­¥éª¤åç§°ï¼šDelete tag and release (åˆ é™¤æ ‡ç­¾å’Œå‘å¸ƒ)
        uses: dev-drprasad/delete-tag-and-release@v1.1 # ä½¿ç”¨ dev-drprasad/delete-tag-and-release@v1.1 åŠ¨ä½œï¼Œç”¨äºåˆ é™¤æŒ‡å®šæ ‡ç­¾å’Œå‘å¸ƒ
        with: # åŠ¨ä½œå‚æ•°é…ç½®
          tag_name: new # è¦åˆ é™¤çš„æ ‡ç­¾åç§°ï¼šnew
          github_token: ${{ secrets.GITHUB_TOKEN }} # GitHub Tokenï¼Œç”¨äºæˆæƒåˆ é™¤æ“ä½œ
  
      - name: Filter and Create Release # æ­¥éª¤åç§°ï¼šFilter and Create Releaseï¼ˆè¿‡æ»¤å’Œåˆ›å»ºå‘å¸ƒï¼‰
        id: create_release # æ­¥éª¤IDï¼šcreate_releaseï¼Œç”¨äºåç»­æ­¥éª¤å¼•ç”¨è¾“å‡º
        run: | # è¿è¡Œçš„ Shell è„šæœ¬
          # Build universal # æ„å»ºé€šç”¨ç‰ˆæœ¬
          zip AppStore.zip $(find . -type f \( -wholename "./*.json" -o -wholename "./Apps/*.yml" \)) # ä½¿ç”¨ zip å‘½ä»¤å°†ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶æ‰“åŒ…æˆ AppStore.zip
          universal_count=$(find ./Apps/ -name "*.yml" | wc -l) # ç»Ÿè®¡ Apps ç›®å½•ä¸‹ yml æ–‡ä»¶çš„æ•°é‡ï¼Œèµ‹å€¼ç»™ universal_count å˜é‡
  
          # Build arm64
          [ -d "./Apps_arm64" ] && cp -rfu ./Apps_arm64/* ./Apps/
          zip AppStore_arm64.zip $(find . -type f -wholename "./*.json" && find . -type f -wholename "./Apps/*.yml" -exec grep -rlPz
          arm64_count=$(find . -type f -wholename "./Apps/*.yml" -exec grep -rlPz 'x-casaos:\s*\n\s*architectures:[\n\s\w-#]*- arm64
          git checkout -- ./Apps && git clean -df ./Apps

          # Build amd64
          [ -d "./Apps_amd64" ] && cp -rfu ./Apps_amd64/* ./Apps/
          zip AppStore_amd64.zip $(find . -type f -wholename "./*.json" && find . -type f -wholename "./Apps/*.yml" -exec grep -rlPz
          amd64_count=$(find . -type f -wholename "./Apps/*.yml" -exec grep -rlPz 'x-casaos:\s*\n\s*architectures:[\n\s\w-#]*- amd64

          echo "app_counts=universal($universal_count), arm64($arm64_count), amd64($amd64_count)" >> $GITHUB_OUTPUT # å°†åº”ç”¨æ•°é‡ä¿¡æ¯è¾“å‡ºåˆ° GITHUB_OUTPUT ç¯å¢ƒå˜é‡ï¼Œå˜é‡åä¸º app_countsï¼Œæ ¼å¼ä¸º universal(æ•°é‡)
  
      - name: Proxy get.docker.com # æ­¥éª¤åç§°ï¼šProxy get.docker.comï¼ˆä»£ç† get.docker.comï¼‰
        run: |
          wget https://get.docker.com -O get_docker.sh # ä½¿ç”¨ wget å‘½ä»¤ä¸‹è½½ get.docker.com è„šæœ¬ï¼Œå¹¶ä¿å­˜ä¸º get_docker.sh
        env: # ç¯å¢ƒå˜é‡é…ç½®
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub Tokenï¼Œä¼ é€’ç»™æ­¥éª¤ä½¿ç”¨çš„ç¯å¢ƒå˜é‡

      - name: Upload New Release # æ­¥éª¤åç§°ï¼šUpload New Releaseï¼ˆä¸Šä¼ æ–°å‘å¸ƒï¼‰
        uses: softprops/action-gh-release@v2 # ä½¿ç”¨ softprops/action-gh-release@v2 åŠ¨ä½œï¼Œç”¨äºä¸Šä¼ å‘å¸ƒ
        with: # åŠ¨ä½œå‚æ•°é…ç½®
          files: | # è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
            AppStore.zip # ä¸Šä¼  AppStore.zip æ–‡ä»¶
          tag_name: new # å‘å¸ƒæ ‡ç­¾åç§°ï¼šnew
          name: "v${{ steps.get_commit_messages.outputs.release_date }}" # å‘å¸ƒåç§°ï¼Œæ ¼å¼ä¸º vYYYYMMDDï¼Œä½¿ç”¨ get_commit_messages æ­¥éª¤è¾“å‡ºçš„ release_date å˜é‡
          draft: false # æ˜¯å¦ä¸ºè‰ç¨¿å‘å¸ƒï¼šå¦ï¼Œå³æ­£å¼å‘å¸ƒ
          prerelease: false # æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼šå¦ï¼Œå³æ­£å¼ç‰ˆæœ¬
          body: "## What's Changed\n\n${{ steps.get_commit_messages.outputs.commits }}\n\nğŸ“Š **App Counts:** ${{ steps.create_release.outputs.app_counts }}" # å‘å¸ƒå†…å®¹ï¼ŒåŒ…æ‹¬ What's Changed æ ‡é¢˜ã€æäº¤ä¿¡æ¯ï¼ˆæ¥è‡ª get_commit_messages æ­¥éª¤çš„è¾“å‡ºï¼‰å’Œåº”ç”¨æ•°é‡ç»Ÿè®¡ï¼ˆæ¥è‡ª create_release æ­¥éª¤çš„è¾“å‡ºï¼‰
        env: # ç¯å¢ƒå˜é‡é…ç½®
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub Tokenï¼Œä¼ é€’ç»™æ­¥éª¤ä½¿ç”¨çš„ç¯å¢ƒå˜é‡